# NC 财务智能问数系统实施方案（合并修订版）

> 基于 SQLBot 构建面向 NC 财务系统的智能问数平台，优先保证查询准确度与小白用户开箱即用。

---

## 参考文档

- SQLBot 官方文档：https://dataease.cn/sqlbot/v1/
- 官方最佳实践（四步调优）：https://dataease.cn/sqlbot/v1/best_practice/
- 术语配置：https://dataease.cn/sqlbot/v1/user_manual/professional/
- SQL 示例库：https://dataease.cn/sqlbot/v1/user_manual/data_training/
- 自定义提示词：https://dataease.cn/sqlbot/v1/user_manual/prompt/（X-Pack）
- 本地文档：`docs/developer/nc-financial-tuning-guide.md`、`docs/developer/accuracy-improvement-guide.md`
- 模板参考：`apply/NC_财务术语库_配置模板.md`、`apply/NC_财务SQL示例库_配置模板.md`

---

## 1. 项目目标与范围

### 1.1 目标与指标

| 目标 | 衡量标准 |
|:---|:---|
| 查询精准度 | SQL 首次正确率 > 80%，执行成功率 > 95% |
| 开箱即用 | 非技术用户可完成 20+ 常见财务查询 |
| NC 适配度 | 覆盖 NC 核心财务场景与组织/期间口径 |

### 1.2 范围定义

- In：NC 财务核心场景问数；SQLBot 配置调优；必要二次开发提升稳定性与易用性。
- Out：跨系统联邦查询、复杂报表引擎替代、非财务领域深度定制。

---

## 2. 总体方案与关键决策

### 2.1 官方四步调优方法

```mermaid
graph LR
    A[第一步: 精简数据源/表管理] --> B[第二步: 明确表关系]
    B --> C[第三步: 提供 SQL 示例]
    C --> D[第四步: 建立术语库]
```

> 说明：自定义提示词为 X-Pack 功能；开源版优先完成四步调优即可获得较好效果。

### 2.2 数据层处理策略（二选一）

**方案 A：视图/中间表预处理（推荐但需 DBA 资源）**
- 优点：把 dr=0、vouchstatus>=3 等规则固化在视图里，表关系与 SQL 示例更简单，准确度更稳定。
- 代价：需要 DBA 创建与维护视图，后续表结构变更需同步维护。

**方案 B：直接表配置（DBA 资源不足时）**
- 优点：无需改动数据库结构，实施更快。
- 代价：表关系、示例 SQL、提示词/护栏更复杂，对配置质量要求高。

**建议**：若 DBA 可配合，采用方案 A；否则采用方案 B，并增加 SQL 护栏与模板规则兜底。

---

## 3. 配置类工作清单（按优先级）

### 3.1 P0 配置（必须完成）

**CFG-P0-01：数据访问与安全基线**
- 创建只读账号；配置网络白名单/访问权限；明确审计规则。

**CFG-P0-02：数据源连接与元数据同步**
- 在 SQLBot 创建数据源，填 IP/端口/库名并测试连接。
- 方案 A：仅同步视图；方案 B：同步核心表并关闭无关字段。

**CFG-P0-03：表/字段描述与别名**
- 方案 A：为视图字段设置业务别名与描述。
- 方案 B：为核心表与关键字段写清描述与枚举值。

**CFG-P0-04：表关系管理**
- 方案 A：维护视图间关系。
- 方案 B：维护核心表关系（凭证-分录-科目、余额-科目、组织、客户/供应商）。

**CFG-P0-05：术语库建设**
- 基于 `apply/NC_财务术语库_配置模板.md` 录入 30+ 术语。

**CFG-P0-06：SQL 示例库建设**
- 基于 `apply/NC_财务SQL示例库_配置模板.md` 录入 50+ 示例。
- 方案 A：SQL 基于视图；方案 B：SQL 基于表并含业务过滤。

**CFG-P0-07：权限与安全配置**
- 规则组 + 行级权限（组织隔离）+ 列级权限（敏感字段脱敏）。

**CFG-P0-08：AI 模型配置**
- 添加模型、设置参数、指定默认模型，并验证可调用。

**CFG-P0-09：用户与工作空间配置**
- 创建用户/角色，分配到工作空间，验证隔离与权限生效。

**CFG-P0-10：测试验证与调优**
- 设计 20+ 核心问题场景，执行测试并补齐术语/示例/描述。

### 3.2 P1 配置（尽量完成）

- 术语与示例扩展：财务分析、同比环比、辅助核算。
- 新手问题模板库：沉淀 50-100 个可直接点击的问题。
- 评测集与周度复盘：100 题金标集 + 周期复测。

### 3.3 P2 配置（可选）

- 多组织对比模板与 KPI 扩展。
- 知识库导出/导入打包。
- 嵌入式小助手（如需内嵌系统）。

---

## 4. 二次开发清单（按优先级）

### 4.1 P0 开发（必须）

**DEV-P0-01：SQL 护栏与规则重写**
- 方案 B 必需：在 LLM 输出后注入 dr=0、vouchstatus/billstatus 等过滤。
- 方案 A 可选：视图已覆盖时可简化。

**DEV-P0-02：主题域/表分组与检索收敛**
- NC 表规模大时用于降低检索噪声与幻觉表命中。

**DEV-P0-03：NC Starter Pack 一键导入**
- 把术语/示例/规则打包，首次部署即开箱可用。

**DEV-P0-04：自定义提示词能力兜底**
- 若 X-Pack 不可用，则需补开源版提示词存储与注入链路。

**DEV-P0-05：模板固化与种子数据脚本**
- 模板规则（template.yaml）与种子数据脚本二选一或组合使用。
- 方案 A 视图已固化规则时可减弱此项。

### 4.2 P1 开发（尽量完成）

- 预置财务问题模板（前端快捷入口）。
- 组织切换优化（组织列表 + SQL 注入过滤）。
- 会计期间智能识别（本月/上月/本季度）。
- 性能与安全：超时/成本限制、缓存、大结果提示。

### 4.3 P2 开发（可选）

- 财务看板/报表模板扩展。
- 金额格式化与单位处理。
- 科目编码智能补全。

---

## 5. 时间计划（T0=下周一，截止 2025-02-10）

> 注：如涉及春节假期，请将节假日从计划中剔除。

**Phase A（T0 ~ T0+2 周）**
- 完成 CFG-P0-01..09
- 启动 DEV-P0-01/02 方案设计

**Phase B（T0+2 周 ~ 2025-02-10）**
- 完成 DEV-P0-01/02/03/04/05
- 完成 CFG-P1-01/02/04
- 发布 Starter Pack

**Phase C（2025-02-11 之后）**
- 推进 P2 配置与 P1/P2 开发

---

## 6. 依赖关系（汇总）

- 元数据同步 → 表/字段描述 → 表关系 → SQL 示例
- 术语与示例依赖业务口径与数据字典
- 权限配置依赖组织架构与角色矩阵
- 方案 A 依赖 DBA 视图支持；方案 B 依赖护栏与模板兜底

---

## 7. 资料准备清单

### 数据库相关（P0）
- NC 数据库连接信息（IP/端口/库名）
- 只读账号与授权清单
- NC 版本确认（NC/NCC/BIP）

### 业务相关（P0）
- 常用科目清单（编码+名称）
- 组织架构（编码+名称）
- 常见财务问题清单（20+）
- 业务规则说明（状态口径、过滤逻辑）

### 技术相关（P1）
- NC 表结构文档（如有）
- 现有报表 SQL 样例

---

## 8. 验收标准

- 核心问题首答正确率 > 80%
- SQL 执行成功率 > 95%
- 权限规则生效且满足隔离要求
- 50+ SQL 示例与 30+ 术语可正常检索

---

## 9. 风险与应对

- 自定义提示词为 X-Pack：走 DEV-P0-04 兜底
- 方案 A 视图维护成本高：建立变更同步流程
- NC 表规模大：主题域分组与字段启用控制
- SQL 性能风险：只读账号 + 超时/成本限制

---

*文档版本：v1.1*  
*创建时间：2026-01-07*  
*维护人：待定*
